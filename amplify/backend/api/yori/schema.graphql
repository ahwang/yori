# Yori Financial Planning App GraphQL Schema
# Supports Firebase Authentication integration with AWS Amplify backend

# Authorization: Use API key with Firebase JWT validation in Lambda functions
input AMPLIFY { globalAuthRule: AuthRule = { allow: public } }

# User Profile - Core user data linked to Firebase UID
type UserProfile @model
  @auth(rules: [
    { allow: public, operations: [create, read, update, delete] }
  ]) {
  id: ID
  firebaseUID: String @index(name: "byFirebaseUID")
  email: String
  displayName: String
  onboardingCompleted: Boolean
  hasConnectedAccounts: Boolean
  preferredCurrency: String
  createdAt: AWSDateTime
  updatedAt: AWSDateTime

  # Relationships
  connectedAccounts: [ConnectedAccount] @hasMany(indexName: "byUserProfile", fields: ["id"])
  financialSummaries: [FinancialSummary] @hasMany(indexName: "byUserProfile", fields: ["id"])
  plaidTokens: [PlaidToken] @hasMany(indexName: "byUserProfile", fields: ["id"])
}

# Connected Accounts - Bank accounts linked via Plaid or manual entry
type ConnectedAccount @model
  @auth(rules: [
    { allow: public, operations: [create, read, update, delete] }
  ]) {
  id: ID!
  userProfileID: ID! @index(name: "byUserProfile")
  accountName: String!
  accountType: AccountType!
  balance: Float!
  institution: String!
  plaidAccountID: String
  plaidItemID: String
  isActive: Boolean!
  lastSynced: AWSDateTime
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!

  # Relationships
  userProfile: UserProfile @belongsTo(fields: ["userProfileID"])
}

# Plaid Tokens - Secure storage of Plaid access tokens per institution
type PlaidToken @model
  @auth(rules: [
    { allow: public, operations: [create, read, update, delete] }
  ]) {
  id: ID!
  userProfileID: ID! @index(name: "byUserProfile")
  itemID: String!
  accessToken: String! # Should be encrypted in production
  institutionID: String!
  institutionName: String!
  isActive: Boolean!
  lastUsed: AWSDateTime
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!

  # Relationships
  userProfile: UserProfile @belongsTo(fields: ["userProfileID"])
}

# Financial Summary - Calculated financial overview
type FinancialSummary @model
  @auth(rules: [
    { allow: public, operations: [create, read, update, delete] }
  ]) {
  id: ID!
  userProfileID: ID! @index(name: "byUserProfile")
  netWorth: Float!
  totalAssets: Float!
  totalLiabilities: Float!
  netWorthChangePercent: Float
  assetBreakdown: AWSJSON # JSON string of asset categories
  calculatedAt: AWSDateTime!
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!

  # Relationships
  userProfile: UserProfile @belongsTo(fields: ["userProfileID"])
}

# Account Types Enum
enum AccountType {
  CHECKING
  SAVINGS
  CREDIT_CARD
  INVESTMENT
  RETIREMENT
  MORTGAGE
  LOAN
  OTHER
}

# Plaid Link Token Response
type PlaidLinkToken {
  linkToken: String!
  expiration: String
}

# Custom Mutations for Firebase Integration
type Mutation {
  # Create user profile with Firebase UID verification
  createUserProfileWithFirebase(
    firebaseUID: String!
    email: String
    displayName: String
  ): UserProfile @function(name: "createUserProfileWithFirebase-${env}")

  # Create Plaid Link token for connecting accounts
  createPlaidLinkToken(
    userProfileID: ID!
  ): PlaidLinkToken @function(name: "createPlaidLinkToken-${env}")

  # Sync Plaid accounts after Link flow
  syncPlaidAccounts(
    publicToken: String!
    userProfileID: ID!
  ): [ConnectedAccount] @function(name: "syncPlaidAccounts-${env}")

  # Calculate comprehensive financial summary
  calculateFinancialSummary(
    userProfileID: ID!
  ): FinancialSummary @function(name: "calculateFinancialSummary-${env}")

  # Refresh account balances via Plaid
  refreshAccountBalances(
    userProfileID: ID!
  ): [ConnectedAccount] @function(name: "refreshAccountBalances-${env}")
}

# Custom Queries for optimized data fetching
type Query {
  # Get user profile by Firebase UID (throws USER_NOT_FOUND error if not found)
  getUserProfileByFirebaseUID(
    firebaseUID: String!
  ): UserProfile @function(name: "getUserProfileByFirebaseUID-${env}")

  # Get latest financial summary for user
  getFinancialSummaryForUser(
    userProfileID: ID!
  ): FinancialSummary @function(name: "getFinancialSummaryForUser-${env}")

  # Get active connected accounts for user
  getActiveConnectedAccounts(
    userProfileID: ID!
  ): [ConnectedAccount] @function(name: "getActiveConnectedAccounts-${env}")
}
